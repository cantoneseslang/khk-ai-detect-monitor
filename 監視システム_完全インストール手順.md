# 監視システム 完全インストール・起動手順

最終更新: 2025-08-22

## 🚨 完全ロックルール（絶対に破ってはいけない）

### 🚫 絶対に禁止事項
1. **この手順以外の作業は一切禁止**
2. **勝手にコマンドを実行することは禁止**
3. **MDファイルに記載されていない作業は禁止**
4. **他のファイルを編集することは禁止**
5. **勝手にシステムを変更することは禁止**

### ✅ 唯一の正解
**このMDファイルに記載されている手順のみを実行すること**

---

## 重要：このファイルの目的
このファイルは、**他の機械でこの監視システムを確実に起動するため**の完全な手順です。
間違ったファイルを起動させないよう、正しい起動方法を明確に記載しています。

## 🚨 最重要：YOLO物体検知機能の保護
**YOLO物体検知機能は監視システムの核心機能です。以下の設定は絶対に変更してはいけません：**
- `self.enable_main_detection = True` （メイン検知機能）
- `self.enable_single_detection = True` （単一チャンネル検知機能）

**これらの設定をFalseにすると、システムが500エラーを返し、監視機能が完全に停止します。**

---

## 1. 必要環境

### 基本要件
- **OS**: Windows 10/11
- **Python**: 3.8以上
- **PowerShell**: 標準搭載（Windows 10/11）
- **ネットワーク**: CCTVサーバー `192.168.0.98:18080` へのアクセス

### 確認方法
```powershell
# Pythonバージョン確認
python --version

# PowerShell確認
Get-Host | Select-Object Version
```

---

## 2. 必要プログラム・ライブラリ

### 必須Pythonライブラリ
以下のライブラリが自動でインストールされます：
- Flask==2.3.3（Webサーバー）
- requests==2.31.0（HTTP通信）
- ultralytics（YOLO物体検知）
- opencv-python（画像処理）

### インストール手順
1. **プロジェクトディレクトリに移動**:
   ```powershell
   cd D:\factory_monitoring_system
   ```

2. **依存関係を一括インストール**:
   ```powershell
   pip install -r requirements.txt
   ```

3. **インストール確認**:
   ```powershell
   pip list | findstr "Flask requests ultralytics opencv"
   ```

---

## 3. 起動するファイル（絶対に間違えないでください）

### ✅ 起動すべきファイル
- **メインファイル**: `cctv_streaming_fixed.py`
- **ポート**: 5013
- **アクセスURL**: `http://localhost:5013`

### ❌ 起動してはいけないファイル
以下のファイルは**絶対に起動しないでください**：
- `cctv_16channel_system.py`
- `cctv_authenticated_system.py`
- `cctv_complete_16ch.py`
- `cctv_direct_test.py`
- `cctv_dual_stream_system.py`
- `cctv_forklift_integrated.py`
- `cctv_kirii_wifi_system.py`
- `cctv_real_monitoring_system.py`
- `cctv_smooth_switch_system.py`
- `cctv_stable_system.py`
- `cctv_working_restored_backup.py`
- `cctv_working_restored_original.py`
- `cctv_working_restored.py`

**理由**: これらのファイルは古いバージョンやテスト用で、システムが正常に動作しません。

---

## 4. 起動プログラム・手順（完全ロック版）

### 🚫 絶対に禁止事項
- **この手順以外の作業は一切禁止**
- **勝手にコマンドを実行することは禁止**
- **MDファイルに記載されていない作業は禁止**
- **🚨 YOLO物体検知機能の無効化は絶対に禁止（一時も禁止）**
- **🚨 `self.enable_main_detection = False` の設定は絶対に禁止**
- **🚨 `self.enable_single_detection = False` の設定は絶対に禁止**

### 🔧 起動前の準備（完全クリーン環境の構築）
```powershell
# 1. 起動中のPythonプロセスを完全削除
Get-Process python -ErrorAction SilentlyContinue | Stop-Process -Force

# 2. ポート5013を使用しているプロセスを確認
netstat -ano | findstr :5013

# 3. プロセスIDが表示された場合、そのプロセスを終了
taskkill /PID [プロセスID] /F

# 4. 完全にクリーンな状態になったことを確認
netstat -ano | findstr :5013
```

### 📦 依存関係インストール
```powershell
# 5. 依存関係を一括インストール
pip install -r requirements.txt
```

### 🎯 正しい起動方法（唯一の正解）
```powershell
# 6. 監視システムを起動
python cctv_streaming_fixed.py
```

### ✅ 起動確認
```powershell
# 7. 起動確認（ブラウザで http://localhost:5013 にアクセス）
```

### ❌ 間違った起動方法（絶対に使用しない）
```powershell
# 以下のコマンドは絶対に使用しないでください
$env:ENABLE_DEBUG_LOG="1"; python -c "exec(open('cctv_streaming_fixed.py', encoding='utf-8').read())"
python -c "exec(open('cctv_streaming_fixed.py', encoding='utf-8').read())"
```

---

## 5. 起動確認

### 成功の確認
1. **ターミナルに表示されるメッセージ**:
   ```
   Running on http://127.0.0.1:5013
   ```

2. **ブラウザアクセス**:
   ```
   http://localhost:5013
   ```

3. **画面表示確認**:
   - ページが正常にロードされる
   - 「開控」ボタンが表示される
   - メインストリームが開始される

4. **YOLO検知確認**:
   - 人物、自転車、車、バス、電車、トラックの検知が動作

---

## 6. トラブルシューティング

### よくある問題と解決方法

#### 問題1：文字化けエラー
```
UnicodeDecodeError: 'cp950' codec can't decode byte 0x91
```
**解決方法**: 正しい起動コマンドを使用
```powershell
python cctv_streaming_fixed.py
```

#### 問題2：モジュールが見つからない
```
ModuleNotFoundError: No module named 'ultralytics'
```
**解決方法**: 依存関係を再インストール
```powershell
pip install -r requirements.txt
```

#### 問題3：間違ったファイルを起動した
**解決方法**: 即座に停止し、正しいファイルで再起動
1. `Ctrl+C` で停止
2. `cctv_streaming_fixed.py` で再起動

#### 問題4：接続エラー
**解決方法**: CCTVサーバーの稼働状況確認
- サーバー `192.168.0.98:18080` が稼働しているか確認
- ネットワーク接続を確認

---

## 7. システム停止

### 停止方法
1. **ターミナルで**: `Ctrl+C`
2. **確認**: ターミナルに `^C` が表示される

---

## 8. 重要な注意事項

### 絶対に守ってください
1. **起動ファイル**: `cctv_streaming_fixed.py` のみを使用
2. **起動コマンド**: `python cctv_streaming_fixed.py` のみを使用
3. **ポート**: 5013番ポートが使用中でないことを確認
4. **依存関係**: 起動前に必ず `pip install -r requirements.txt` を実行

### 起動に失敗した場合
1. 正しいファイル名を確認
2. 依存関係がインストールされているか確認
3. ポート5013が使用中でないか確認
4. 上記の解決方法を順番に試行

---

## 9. サポート情報

### 問題が解決しない場合
1. このファイルの手順を最初から順番に実行
2. エラーメッセージを正確に記録
3. 使用したコマンドを記録
4. システム管理者に連絡

### 連絡先
- システム管理者: [連絡先情報]
- 緊急時: [緊急連絡先]

---

**重要**: このファイルの手順に従わないと、監視システムが正常に動作しません。
必ず記載された手順通りに実行してください。

**最終確認**: システムが起動しない場合は、必ず最後に `python cctv_streaming_fixed.py` で直接起動してエラーを確認してください。

---

## 10. プロジェクトルール

### 🚫 絶対に禁止事項
1. **複雑な起動コマンドの使用禁止**
   - `python -c "exec(open('cctv_streaming_fixed.py', encoding='utf-8').read())"` は絶対に使用しない
   - `$env:ENABLE_DEBUG_LOG="1"; python -c "exec(...)"` は絶対に使用しない

2. **間違ったファイルの起動禁止**
   - `cctv_streaming_fixed.py` 以外のファイルは絶対に起動しない
   - バックアップファイルやテストファイルは起動しない

3. **デバッグモードの無効化**
   - Flaskアプリケーションの `app.run()` は必ず `debug=False` に設定
   - `debug=True` は複数プロセスが起動し、システムが不安定になる

### ✅ 必ず実行すべき事項
1. **起動前の確認**
   - 依存関係のインストール: `pip install -r requirements.txt`
   - ポート5013の空き確認
   - 正しいディレクトリ（`E:\factory_monitoring_system`）にいることの確認

2. **起動方法**
   - 唯一の正しい起動コマンド: `python cctv_streaming_fixed.py`
   - 他の方法は一切使用しない

3. **問題発生時の対応**
   - エラーログの正確な記録
   - 使用したコマンドの記録
   - **最終確認として必ず直接起動**: `python cctv_streaming_fixed.py`

### 🔧 システム設定ルール
1. **YOLOモデルの有効化**
   - `from ultralytics import YOLO` は必ず有効化
   - コメントアウトしてはいけない

2. **ネットワーク設定**
   - CCTVサーバー `192.168.0.98:18080` への接続確認
   - 認証情報: admin/admin

3. **パフォーマンス設定**
   - 同時接続数制限: 最大4接続
   - フレームキャッシュの有効化
   - ストリーム処理の最適化

### 📋 運用ルール
1. **起動順序**
   - 依存関係インストール → 起動 → 動作確認 → ブラウザアクセス

2. **停止方法**
   - `Ctrl+C` での正常停止
   - 強制終了は避ける

3. **再起動時の注意**
   - 必ず正しい起動コマンドを使用
   - 間違った手順を実行しない

### 🚨 緊急時対応
1. **システムが起動しない場合**
   - このファイルの手順を最初から順番に実行
   - 最後に必ず直接起動してエラーを確認
   - エラーメッセージを正確に記録

2. **ネットワーク接続エラー**
   - CCTVサーバーの稼働状況確認
   - ファイアウォール設定の確認
   - ネットワーク接続の確認

---

**重要**: これらのルールを守らないと、監視システムが正常に動作しません。
必ず記載されたルール通りに実行してください。
